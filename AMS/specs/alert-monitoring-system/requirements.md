# Requirements Document

## Introduction

This document defines the requirements for an Alert Monitoring System that enables property owners to receive, view, and manage real-time alerts from IoT devices across their properties. The system provides a backend API for alert ingestion and management, real-time WebSocket updates, and frontend interfaces for alert visualization and interaction.

## Glossary

- **Alert System**: The complete alert monitoring and management platform
- **Alert**: A notification generated by an IoT device indicating an event requiring attention
- **Owner Dashboard**: The web interface displaying a list of all alerts for a property owner
- **System Dashboard**: The React-based comprehensive dashboard for owners, caregivers, and admins
- **Alert Detail Page**: The web interface showing detailed information about a single alert
- **Backend API**: The Express.js server handling alert data and business logic
- **WebSocket Server**: The real-time communication channel for live alert updates
- **Relational Database**: PostgreSQL database storing users, houses, devices, alerts, and configurations
- **Time-Series Database**: MongoDB database storing telemetry and ML inference metadata
- **Severity Level**: The priority classification of an alert (low, medium, high, critical)
- **Alert Status**: The current state of an alert (open, acknowledged, resolved)
- **Alert State**: The workflow state of an alert (new, acked, escalated, resolved)
- **Alert History**: The audit trail of all actions performed on an alert
- **JWT Token**: JSON Web Token used for authentication and authorization
- **User Role**: The permission level of a user (OWNER, ADMIN, STAFF, CAREGIVER)
- **KPI**: Key Performance Indicator metrics (MTTA, MTTR, open alerts count)
- **MTTA**: Mean Time To Acknowledge - average time to acknowledge alerts
- **MTTR**: Mean Time To Resolve - average time to resolve alerts
- **Telemetry**: Time-series sensor data from IoT devices (SNR, RMS, decibel levels)
- **ML Inference**: Machine learning model predictions and confidence scores

## Requirements

### Requirement 1

**User Story:** As a property owner, I want to see all alerts from my properties in real-time, so that I can quickly respond to security or safety events.

#### Acceptance Criteria

1. WHEN the Owner Dashboard loads, THE Alert System SHALL retrieve and display all alerts ordered by timestamp descending
2. WHEN a new alert is created, THE Alert System SHALL broadcast the alert to all connected clients via WebSocket within 1 second
3. WHEN an alert is updated, THE Alert System SHALL broadcast the updated alert to all connected clients via WebSocket within 1 second
4. THE Alert System SHALL display alert count, timestamp, type, house ID, severity, and status for each alert in the list
5. THE Alert System SHALL provide clickable links to view detailed information for each alert

### Requirement 2

**User Story:** As a property owner, I want to filter alerts by status, so that I can focus on alerts that require my attention.

#### Acceptance Criteria

1. THE Alert System SHALL provide a status filter with options for "All", "open", "acknowledged", and "resolved"
2. WHEN a status filter is selected, THE Alert System SHALL retrieve and display only alerts matching the selected status
3. THE Alert System SHALL update the alert count to reflect the number of filtered alerts
4. THE Alert System SHALL maintain filter selections until the user changes them

### Requirement 3

**User Story:** As a property owner, I want to generate test alerts, so that I can verify the system is working correctly.

#### Acceptance Criteria

1. THE Alert System SHALL provide buttons to generate glass break, smoke alarm, and dog bark test alerts
2. WHEN a generator button is clicked, THE Alert System SHALL create a new alert with the corresponding type and appropriate severity
3. THE Alert System SHALL assign severity "high" to glass break alerts
4. THE Alert System SHALL assign severity "critical" to smoke alarm alerts
5. THE Alert System SHALL assign severity "low" to dog bark alerts

### Requirement 4

**User Story:** As a property owner, I want to view detailed information about a specific alert, so that I can understand the full context before taking action.

#### Acceptance Criteria

1. WHEN an alert detail page loads, THE Alert System SHALL retrieve and display the alert's type, severity, status, message, and creation timestamp
2. THE Alert System SHALL retrieve and display the complete history of actions performed on the alert
3. THE Alert System SHALL display history entries with timestamp, action type, actor, and optional notes
4. THE Alert System SHALL order history entries chronologically from oldest to newest
5. THE Alert System SHALL provide a link to return to the Owner Dashboard

### Requirement 5

**User Story:** As a property owner, I want to acknowledge alerts, so that I can indicate I am aware of the issue and am taking action.

#### Acceptance Criteria

1. THE Alert System SHALL provide an "Acknowledge" button on the Alert Detail Page
2. WHEN the acknowledge button is clicked, THE Alert System SHALL update the alert status to "acknowledged"
3. WHEN an alert is acknowledged, THE Alert System SHALL record the actor name and timestamp
4. WHEN an alert is acknowledged, THE Alert System SHALL create a history entry with action "ack"
5. WHEN an alert is acknowledged, THE Alert System SHALL refresh the displayed alert information within 1 second

### Requirement 6

**User Story:** As a property owner, I want to resolve alerts, so that I can mark issues as completed and remove them from my active alert list.

#### Acceptance Criteria

1. THE Alert System SHALL provide a "Resolve" button on the Alert Detail Page
2. WHEN the resolve button is clicked, THE Alert System SHALL update the alert status to "resolved"
3. WHEN an alert is resolved, THE Alert System SHALL record the actor name and timestamp
4. WHEN an alert is resolved, THE Alert System SHALL create a history entry with action "resolve"
5. WHEN an alert is resolved, THE Alert System SHALL refresh the displayed alert information within 1 second

### Requirement 7

**User Story:** As an IoT device, I want to send alerts to the system via API, so that property owners are notified of detected events.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/alerts/ingest" for alert creation
2. WHEN an alert is ingested, THE Backend API SHALL accept tenant_id, house_id, device_id, type, and message parameters
3. WHEN an alert is ingested without a type parameter, THE Backend API SHALL return a 400 error with message "type required"
4. WHEN an alert is ingested, THE Backend API SHALL assign severity based on the alert type using predefined rules
5. WHEN an alert is ingested, THE Backend API SHALL create the alert with status "open" and generate a unique ID
6. WHEN an alert is ingested, THE Backend API SHALL create a history entry with action "created"
7. WHEN an alert is ingested, THE Backend API SHALL log a notification action indicating email would be sent to the owner

### Requirement 8

**User Story:** As a system administrator, I want alerts to be stored persistently, so that alert data is not lost if the server restarts.

#### Acceptance Criteria

1. THE Backend API SHALL use SQLite database with WAL mode enabled for data persistence
2. THE Alert Database SHALL store alert records with id, tenant_id, house_id, device_id, type, severity, status, message, timestamp, and acknowledgment/resolution metadata
3. THE Alert Database SHALL store history records with id, alert_id, action, actor, note, and timestamp
4. THE Backend API SHALL create database tables on startup if they do not exist
5. THE Backend API SHALL maintain referential integrity between alerts and their history records

### Requirement 9

**User Story:** As a property owner, I want to search for alerts by multiple criteria, so that I can find specific alerts quickly.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/alerts/search" for alert queries
2. THE Backend API SHALL support filtering by severity, status, type, and since timestamp
3. THE Backend API SHALL support limiting the number of results returned with a default limit of 50
4. WHEN multiple filters are provided, THE Backend API SHALL apply all filters using AND logic
5. THE Backend API SHALL return alerts ordered by timestamp descending

### Requirement 10

**User Story:** As a frontend application, I want to establish WebSocket connections for real-time updates, so that users see changes immediately without refreshing.

#### Acceptance Criteria

1. THE WebSocket Server SHALL listen for connections at path "/ws"
2. WHEN a client connects, THE WebSocket Server SHALL send a "hello" message with payload "connected"
3. THE WebSocket Server SHALL broadcast messages to all connected clients when alerts are created or updated
4. THE WebSocket Server SHALL send messages in JSON format with "type" and "payload" fields
5. THE WebSocket Server SHALL only send to clients with ready state equal to 1 (open connection)

### Requirement 11

**User Story:** As a user, I want to authenticate with email and password, so that I can securely access the system.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/auth/login" for user authentication
2. WHEN login credentials are provided, THE Backend API SHALL validate email and password using bcrypt comparison
3. WHEN credentials are valid, THE Backend API SHALL return an access token, refresh token, and user object
4. WHEN credentials are invalid, THE Backend API SHALL return a 401 error with message "Invalid credentials"
5. THE Backend API SHALL generate JWT access tokens with 1 hour expiration
6. THE Backend API SHALL generate refresh tokens with 7 day expiration and store them in the database

### Requirement 12

**User Story:** As a user, I want to refresh my access token, so that I can maintain my session without re-entering credentials.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/auth/refresh" for token refresh
2. WHEN a valid refresh token is provided, THE Backend API SHALL validate it against stored tokens
3. WHEN refresh token is valid, THE Backend API SHALL return a new access token
4. WHEN refresh token is invalid or expired, THE Backend API SHALL return a 401 error
5. THE Backend API SHALL mark refresh tokens as revoked when used

### Requirement 13

**User Story:** As a user, I want to logout, so that my session is terminated and tokens are invalidated.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/auth/logout" for session termination
2. WHEN a refresh token is provided, THE Backend API SHALL mark it as revoked in the database
3. THE Backend API SHALL return success confirmation after logout
4. THE Backend API SHALL prevent revoked tokens from being used for refresh operations

### Requirement 14

**User Story:** As an authenticated user, I want all API requests to be protected, so that unauthorized users cannot access system data.

#### Acceptance Criteria

1. THE Backend API SHALL implement JWT middleware that validates access tokens on protected endpoints
2. WHEN a request lacks an access token, THE Backend API SHALL return a 401 error with message "Authentication required"
3. WHEN a request has an invalid or expired token, THE Backend API SHALL return a 401 error with message "Invalid or expired token"
4. THE Backend API SHALL extract user information from valid tokens and attach it to the request object
5. THE Backend API SHALL enforce role-based access control on admin-only endpoints

### Requirement 15

**User Story:** As a property owner, I want to view my houses, so that I can see which properties I manage.

#### Acceptance Criteria

1. THE Backend API SHALL provide a GET endpoint at "/api/v1/houses" for retrieving houses
2. WHEN an authenticated owner requests houses, THE Backend API SHALL return only houses owned by that user
3. THE Backend API SHALL return house records with house_id, owner_id, address, timezone, and created_at
4. WHEN an admin requests houses, THE Backend API SHALL return all houses in the system
5. THE Backend API SHALL order houses by created_at descending

### Requirement 16

**User Story:** As a property owner, I want to view and manage devices, so that I can monitor IoT device status across my properties.

#### Acceptance Criteria

1. THE Backend API SHALL provide a GET endpoint at "/api/v1/devices" for retrieving devices
2. THE Backend API SHALL support filtering by owner_id, house_id, status, and device_type
3. THE Backend API SHALL support pagination with page and pageSize query parameters with default pageSize of 50
4. THE Backend API SHALL return device records with device_id, house_id, device_type, status, name, and timestamps
5. THE Backend API SHALL order devices by created_at descending

### Requirement 17

**User Story:** As a property owner, I want to register new devices, so that I can add IoT sensors to my properties.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/devices" for device registration
2. WHEN device data is provided, THE Backend API SHALL validate required fields: owner_id, house_id, device_type, name
3. WHEN validation passes, THE Backend API SHALL insert device record into the database with status "active"
4. WHEN device is created, THE Backend API SHALL return the complete device object with generated device_id
5. THE Backend API SHALL return a 400 error when required fields are missing

### Requirement 18

**User Story:** As a property owner, I want to view detailed device information, so that I can check device configuration and status.

#### Acceptance Criteria

1. THE Backend API SHALL provide a GET endpoint at "/api/v1/devices/:id" for retrieving device details
2. WHEN a device_id is provided, THE Backend API SHALL return the device record with associated house information
3. WHEN device_id does not exist, THE Backend API SHALL return a 404 error with message "Device not found"
4. THE Backend API SHALL include device telemetry summary in the response
5. THE Backend API SHALL verify the requesting user has access to the device's house

### Requirement 19

**User Story:** As an IoT device, I want to send telemetry data, so that the system can monitor device health and performance.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/devices/:id/metrics" for telemetry ingestion
2. WHEN telemetry data is provided, THE Backend API SHALL accept timestamp and metrics object with SNR, RMS, decibel values
3. WHEN telemetry is received, THE Backend API SHALL store the document in the time-series database
4. THE Backend API SHALL validate that device_id exists before storing telemetry
5. THE Backend API SHALL return success confirmation with stored document ID

### Requirement 20

**User Story:** As a property owner, I want to view alert metrics by day, so that I can analyze alert trends over time.

#### Acceptance Criteria

1. THE Backend API SHALL provide a GET endpoint at "/api/v1/metrics/alerts-by-day" for daily alert aggregation
2. THE Backend API SHALL accept query parameters: owner_id, start_date, end_date
3. THE Backend API SHALL return per-day counts with date, total, and counts by severity (low, medium, high, critical)
4. THE Backend API SHALL order results by date ascending
5. THE Backend API SHALL default to last 30 days when date range is not specified

### Requirement 21

**User Story:** As a property owner, I want to view device metrics, so that I can monitor device health and alert generation.

#### Acceptance Criteria

1. THE Backend API SHALL provide a GET endpoint at "/api/v1/metrics/device/:id" for device metrics
2. WHEN device_id is provided, THE Backend API SHALL calculate uptime percentage based on heartbeat data
3. THE Backend API SHALL return total alerts generated by the device
4. THE Backend API SHALL return average SNR from telemetry data
5. THE Backend API SHALL return last_seen timestamp from most recent telemetry or heartbeat

### Requirement 22

**User Story:** As a system integrator, I want to send data to ML prediction service, so that the system can classify audio events.

#### Acceptance Criteria

1. THE Backend API SHALL provide a POST endpoint at "/api/v1/ml/predict" for ML inference requests
2. WHEN inference data is provided, THE Backend API SHALL accept device_id, window_uri, timestamp, and features
3. THE Backend API SHALL call ML service with provided data or return mock prediction for development
4. THE Backend API SHALL store inference result in time-series database with model_name, score, and label
5. THE Backend API SHALL return prediction object with label and confidence score

### Requirement 23

**User Story:** As a property owner, I want to view KPI dashboard, so that I can monitor system health at a glance.

#### Acceptance Criteria

1. THE System Dashboard SHALL display open alerts count prominently
2. THE System Dashboard SHALL display MTTA (Mean Time To Acknowledge) in human-readable format
3. THE System Dashboard SHALL display MTTR (Mean Time To Resolve) in human-readable format
4. THE System Dashboard SHALL display severity breakdown chart showing counts by severity level
5. THE System Dashboard SHALL display alerts-by-day trend chart for the last 7 days

### Requirement 24

**User Story:** As a property owner, I want to view live alerts feed, so that I can see new alerts as they occur.

#### Acceptance Criteria

1. THE System Dashboard SHALL provide a live alerts page displaying alerts in table format
2. THE System Dashboard SHALL display occurred time, house, device, type, severity chip, state, and score for each alert
3. WHEN a new alert is created, THE System Dashboard SHALL prepend it to the live feed without page refresh
4. THE System Dashboard SHALL provide inline Acknowledge and Escalate buttons for each alert
5. THE System Dashboard SHALL update alert rows in real-time when state changes via WebSocket

### Requirement 25

**User Story:** As a property owner, I want to view alert history with filters, so that I can find specific past alerts.

#### Acceptance Criteria

1. THE System Dashboard SHALL provide an alert history page with filter controls
2. THE System Dashboard SHALL support filtering by date range, severity (multi-select), state, house, and device
3. WHEN filters are applied, THE System Dashboard SHALL call search API with filter parameters
4. THE System Dashboard SHALL support pagination with configurable page size
5. THE System Dashboard SHALL support bulk acknowledge action for selected alerts

### Requirement 26

**User Story:** As a property owner, I want to view alert detail with full history, so that I can understand the complete alert lifecycle.

#### Acceptance Criteria

1. THE System Dashboard SHALL provide an alert detail drawer or page when an alert is clicked
2. THE System Dashboard SHALL display alert header with type, severity chip, state, and timestamps
3. THE System Dashboard SHALL display context information including house, device, and ML score if available
4. THE System Dashboard SHALL display history timeline with all actions ordered chronologically
5. THE System Dashboard SHALL provide Acknowledge, Escalate, and Resolve buttons based on current state

### Requirement 27

**User Story:** As a property owner, I want to resolve alerts with notes, so that I can document resolution actions.

#### Acceptance Criteria

1. THE System Dashboard SHALL require a resolution note when Resolve button is clicked
2. WHEN resolve is attempted without a note, THE System Dashboard SHALL display inline validation error
3. WHEN resolve is submitted with a note, THE System Dashboard SHALL call resolve API with actor and note
4. WHEN resolve succeeds, THE System Dashboard SHALL update alert state to resolved and refresh display
5. WHEN resolve fails with 409 error, THE System Dashboard SHALL show toast "Already resolved, refreshing..." and reload alert

### Requirement 28

**User Story:** As a property owner, I want state-aware action buttons, so that I only see valid actions for each alert state.

#### Acceptance Criteria

1. WHEN alert state is "new", THE System Dashboard SHALL show Acknowledge and Escalate buttons
2. WHEN alert state is "acked", THE System Dashboard SHALL show only Resolve button
3. WHEN alert state is "escalated", THE System Dashboard SHALL show Acknowledge and Resolve buttons
4. WHEN alert state is "resolved", THE System Dashboard SHALL hide all action buttons
5. THE System Dashboard SHALL disable action buttons while API request is in progress

### Requirement 29

**User Story:** As a property owner, I want WebSocket reconnection, so that I maintain real-time updates even if connection drops.

#### Acceptance Criteria

1. WHEN WebSocket connection is lost, THE System Dashboard SHALL display a "Reconnecting..." banner
2. THE System Dashboard SHALL attempt to reconnect with exponential backoff starting at 1 second
3. WHEN reconnection succeeds, THE System Dashboard SHALL hide the banner and refresh current data
4. THE System Dashboard SHALL limit reconnection attempts to 10 before requiring manual refresh
5. THE System Dashboard SHALL log connection status changes to browser console

### Requirement 30

**User Story:** As a property owner, I want accessible UI, so that I can use the system with keyboard and screen readers.

#### Acceptance Criteria

1. THE System Dashboard SHALL support keyboard navigation for all interactive elements
2. THE System Dashboard SHALL provide ARIA live region for new alert announcements
3. THE System Dashboard SHALL maintain color contrast ratio of at least 4.5:1 for text
4. THE System Dashboard SHALL provide focus indicators for all focusable elements
5. THE System Dashboard SHALL label all form inputs and buttons with descriptive text
